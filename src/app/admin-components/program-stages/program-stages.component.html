<!-- Enhanced Program Stages Management with Beautiful Dark Theme -->
<div class="min-h-screen bg-gray-900 text-white">

  <!-- Program Header -->
  <app-program-header
    [program]="program"
    (createStage)="openCreateStageModal()"
    (openTemplates)="openStageTemplatesModal()"
    (openBulkActions)="openBulkActionsModal()"
    (openAnalytics)="openAnalyticsModal()">
  </app-program-header>

  <div class="container mx-auto px-6 py-8">
    <!-- Loading State -->
    <div *ngIf="loading" class="flex items-center justify-center py-20">
      <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500"></div>
      <p class="ml-4 text-lg text-gray-300">Loading program data...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="error" class="bg-red-900/20 border border-red-500 rounded-lg p-6 mb-8">
      <div class="flex items-center">
        <i class="fas fa-exclamation-triangle text-red-500 text-xl mr-3"></i>
        <p class="text-red-200">{{ error }}</p>
        <button (click)="loadProgramData()"
                class="ml-auto bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded-lg transition-colors">
          Retry
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <div *ngIf="!loading && !error">

      <!-- Program Overview Cards -->
      <app-program-overview-cards
        [stages]="stages"
        [companies]="companies"
        [averageStageTime]="calculateAverageStageTime()"
        [completionRate]="calculateCompletionRate()">
      </app-program-overview-cards>

      <!-- Stage Pipeline -->
      <app-stage-pipeline
        [stages]="stages"
        [companies]="companies"
        [selectedStage]="selectedStage"
        (stageSelected)="selectStage($event)"
        (editStage)="editStage($event)"
        (deleteStage)="deleteStage($event)"
        (duplicateStage)="duplicateStage($event)"
        (viewDetails)="viewStageDetails($event)"
        (bulkAdvance)="bulkAdvanceFromStage($event)"
        (createStage)="openCreateStageModal()">
      </app-stage-pipeline>

      <!-- Stage Companies -->
      <app-stage-companies
        [selectedStage]="selectedStage"
        [companies]="getCompaniesInStage(selectedStage?.id!)"
        [selectedCompanies]="selectedCompanies"
        [canAdvance]="canAdvanceToNextStage(selectedStage?.id!)"
        (companySelected)="toggleCompanySelection($event.company_id)"
        (toggleSelection)="toggleCompanySelection($event)"
        (advanceSelected)="advanceSelectedCompanies()"
        (advanceSingle)="advanceSingleCompany($event)"
        (viewDetails)="viewCompanyDetails($event)"
        (showStatistics)="showStageStatistics()"
        (exportData)="exportStageData()">
      </app-stage-companies>

    </div>
  </div>

  <!-- Statistics Modal -->
  <app-statistics-modal
    [visible]="showingStatistics"
    [statistics]="stageStatistics"
    (close)="hideStatistics()">
  </app-statistics-modal>

  <!-- Company Details Modal -->
  <app-company-details-modal
    [visible]="!!selectedCompanyForDetails"
    [company]="selectedCompanyForDetails"
    [canAdvance]="getCanAdvanceCompany()"
    (close)="closeCompanyDetails()"
    (advanceCompany)="advanceSingleCompany($event)"
    (editCompany)="editCompanyStageInfo($event)"
    (viewHistory)="viewCompanyHistory($event)">
  </app-company-details-modal>

</div>
