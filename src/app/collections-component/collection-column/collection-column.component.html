<div class="float" appClickOutside (clickOutside)="onCloseModal.emit()">
  <div class="collection-create">
    <h4 class="text-black text-bold mb-3">
      {{ column.id ? "Edit column" : "Create column" }}
    </h4>

    <div class="form">
      <div class="group">
        <label for="name">Name</label>
        <input
          type="text"
          id="name"
          [(ngModel)]="column.name"
          name="name"
          placeholder="Column name"
          required
          [ngClass]="{ 'is-invalid': column.name === '' }"
        />
      </div>
      <div class="group">
        <label for="name">Type</label>
        <select
          id="type"
          [(ngModel)]="column.type"
          name="type"
          required
          [ngClass]="{ 'is-invalid': column.type === '' }"
        >
          <option *ngFor="let type of fieldTypes" [value]="type.value">
            {{ type.label }}
          </option>
        </select>
      </div>

      <div class="group" *ngIf="hasDefaultValue(column.type)">
        <label for="defaultValue">Default value</label>
        <input
          [type]="column.type"
          id="name"
          [(ngModel)]="column.defaultValue"
          name="name"
          placeholder="Default value (Optional)"
        />
      </div>

      <!-- Only show when reference type -->
      <div *ngIf="column.type === 'reference'">
        <div class="group">
          <label for="target">Target Collection</label>
          <select
            [(ngModel)]="column.referenceCollectionId"
            [ngClass]="{ 'is-invalid': !column.referenceCollectionId }"
          >
            <option [ngValue]="undefined" disabled>Select collection</option>
            <option *ngFor="let c of collections" [ngValue]="c.id">
              {{ c.name }}
            </option>
          </select>
        </div>

        <div
          class="group"
          *ngIf="column.referenceCollectionId && column.relationship"
        >
          <label for="relation">Relationship</label>
          <select
            [(ngModel)]="column.relationship.direction"
            (change)="onRelationshipChange()"
            [ngClass]="{ 'is-invalid': !column.relationship.direction }"
          >
            <option
              *ngFor="let option of relationshipOptions"
              [ngValue]="option.value"
            >
              {{ option.label }}
            </option>
          </select>
        </div>

        <div
          class="group"
          *ngIf="column.referenceCollectionId && column.relationship"
        >
          <label>
            <input
              type="checkbox"
              [(ngModel)]="column.relationship.createReverse"
            />
            Automatically create reverse field on
            <b>{{ targetCollectionName }}</b>
          </label>
        </div>
      </div>

      <!-- Options Management for select and multi-select types -->
      <div *ngIf="['select', 'multi-select'].includes(column.type)">
        <div class="group">
          <label class="text-sm font-semibold mb-2 block">Options</label>

          <div class="overflow-auto rounded border border-gray-200 shadow-sm">
            <table class="w-full text-sm text-left">
              <thead
                class="bg-gray-100 text-gray-600 font-medium border-b text-xs"
              >
                <tr>
                  <th class="px-3 py-2 w-1/3">Name</th>
                  <th class="px-3 py-2 text-center">Fill</th>
                  <th class="px-3 py-2 text-center">Text</th>
                  <th class="px-3 py-2 text-right">Action</th>
                </tr>
              </thead>
              <tbody>
                <tr
                  *ngFor="let option of column.options; let i = index"
                  class="border-t hover:bg-gray-50"
                >
                  <!-- Name with checkbox and label -->
                  <td class="px-3 py-2 flex items-center gap-2">
                    <input
                      type="checkbox"
                      [(ngModel)]="option.isDefault"
                      class="checkbox"
                      title="Set as default"
                      (change)="refreshDefaultOption(i)"
                    />
                    <input
                      type="text"
                      [(ngModel)]="option.label"
                      (ngModelChange)="onOptionLabelChange(option)"
                      placeholder="Option name"
                      class="input text-sm w-full"
                    />
                  </td>

                  <!-- Background -->
                  <td class="px-3 py-2 text-center">
                    <input
                      type="color"
                      [(ngModel)]="option.background"
                      class="w-6 h-6 rounded border"
                      title="Background Color"
                    />
                  </td>

                  <!-- Text color -->
                  <td class="px-3 py-2 text-center">
                    <input
                      type="color"
                      [(ngModel)]="option.color"
                      class="w-6 h-6 rounded border"
                      title="Text Color"
                    />
                  </td>

                  <!-- Delete -->
                  <td class="px-3 py-2 text-right">
                    <button
                      (click)="removeOption(i)"
                      class="text-red-500 hover:text-red-700 p-1 rounded hover:bg-red-100 transition-colors"
                      title="Remove"
                    >
                      <i class="fas fa-trash-alt"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Preview -->
          <div
            *ngIf="column.options?.length"
            class="mt-4 p-3 border border-gray-100 bg-gray-50 rounded"
          >
            <div class="text-xs font-semibold text-gray-500 mb-2">Preview:</div>
            <div class="flex flex-wrap gap-2">
              <span
                *ngFor="let option of column.options"
                class="px-3 py-1 rounded-full text-xs font-medium"
                [style.backgroundColor]="option.background"
                [style.color]="option.color"
              >
                {{ option.label || "Untitled" }}
              </span>
            </div>
          </div>

          <!-- Add Option Button -->
          <button
            type="button"
            class="w-full mt-4 py-2 text-sm font-medium text-[var(--accent)] border border-dashed border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
            (click)="addOption()"
          >
            <i class="fas fa-plus mr-1"></i> Add Option
          </button>
        </div>
      </div>
      <!-- Auto-sequence field -->
      <div *ngIf="isAutoSequence" class="group">
        <!-- Prefix : ORDER-01 -->
        <label for="prefix">Prefix</label>
        <input
          type="text"
          id="prefix"
          [(ngModel)]="column.prefix"
          name="prefix"
          placeholder="Optional prefix (e.g. ORDER-)"
          class="input"
        />
      </div>

      <div class="pt-1 flex flex-col sm:flex-row justify-end gap-4">
        <button
          (click)="onSubmit.emit(column)"
          type="submit"
          [disabled]="!column.name || !column.type"
          class="px-6 py-2 rounded-lg bg-[var(--accent)] text-black font-semibold hover:brightness-110 transition disabled:opacity-50 disabled:cursor-not-allowed"
        >
          {{ "Save" }}
        </button>
      </div>
    </div>
  </div>
</div>
